<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="SAP Cloud for Customer (18)"
    description="Gmail integration gadget"
    height="20"
    author="Harsha Krishnareddy"
    author_email="harsha.krishnareddy@sap.com"
    author_location="Palo Alto, CA">

    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>

    <!-- The next feature, Caja, is optional, and is supported for
     use only within test domains. Uncomment the tag only for
     non-production gadgets. -->
    <!-- <Require feature="caja"/> -->

    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:HelloWorld
      </Param>
    </Require>

  </ModulePrefs>

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
    <![CDATA[
      <script id="sap-ui-bootstrap" type="text/javascript"
	src="https://axp-cust220.dev.sapbydesign.com/sap/public/ap/ui/repository/SAP_BYD_UI/HTML5/resources/sap-ui-core.js"
		data-sap-ui-libs="sap.client.cod.newui.shared"
		data-sap-ui-theme="sap_bluecrystal"
		data-sap-ui-preload="sync"
		data-sap-ui-xx-test-mobile="true"
		data-sap-ui-xx-bindingSyntax="complex"
		data-sap-ui-compatVersion="1.18"
		data-sap-ui-resourceroots='{"sap.client.cod.newui.shared": "https://axp-cust220.dev.sapbydesign.com/sap/ap/ui/repository/BYD_COD/Runtime/HTML/resources/sap/client/cod/newui/shared/"}'>
	</script>

      <!-- Application launch configuration -->
      <script type="text/javascript">
	
	      sap.ui.getCore().attachInitEvent(function() {
		      jQuery.sap.require("sap.client.cod.newui.shared.js.utils");
		      var oModel = new sap.ui.model.json.JSONModel();
		      oModel.setData("https://axp-cust220.dev.sapbydesign.com");
		      sap.ui.getCore().setModel(oModel,"SERVER");
		
		      sap.client.cod.newui.shared.Utils.isLoggedIn().done(function(){
			      var view = sap.ui.view({type:sap.ui.core.mvc.ViewType.XML, viewName:"sap.client.cod.newui.shared.view.plugin"});
			      view.placeAt("content");
		      }).fail(function(d){
			      var view = sap.ui.view({type:sap.ui.core.mvc.ViewType.XML, viewName:"sap.client.cod.newui.shared.view.login"});
			      view.placeAt("content");
			      var xsrf;
			      if (d && typeof(d) === "object" && (xsrf = $(d).find("Element[name='sap-login-XSRF']").attr("value"))) {
  				    view.getController().setLogonHandler(function(){
  	  				  view.getModel().getData()["sap-login-XSRF"] = xsrf;
  		  			  sap.client.cod.newui.shared.Utils.login(view.getModel().getData()).done(function(){
  			  			view.destroy();
  				  		$("body").empty();
  					  	  var view2 = sap.ui.view({type:sap.ui.core.mvc.ViewType.XML, viewName:"sap.client.cod.newui.shared.view.plugin"});
  						    view2.placeAt("content");
  						    //replace
  					    }).fail(function(d){
  						    var text;
  						    if (d && typeof(d) === "object" && (text = $(d).find("Message[type='error']").attr("text"))) {
  							  view.getModel().getData()["error"] = text;
  							  view.getModel().setData(view.getModel().getData());
  						  }
  						  //show error message
					     });
				      });
      			} else {
      				console.log("error");
      			}
			
		      });
		
	      });
      </script>
    ]]>
  </Content>
</Module>
